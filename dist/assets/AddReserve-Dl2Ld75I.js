import{o as $}from"./oldManRelation-BmOKY2bv.js";import{_ as A}from"./CascaderBeg.vue_vue_type_script_setup_true_lang-_gtH4QnK.js";import{u as W}from"./Uploads-hqb4toZy.js";import{r as J}from"./Reserve-s3Ful1lR.js";import{d as O,r as p,j,z,k as R,o as G,c as V,e as t,w as a,b as d,f,u as h,n as H,p as q,g as D,F as K,v as Q,E as i,B as X,a as _,_ as Z}from"./index-DSXWNbz6.js";import"./building-CNUBr-fR.js";import"./convertToTree-Coeds9PE.js";import"./house-0UauvkXi.js";const ee={class:"reservation-page"},le={class:"form-section"},te={class:"form-section"},ae={key:1,class:"image-preview-area"},oe=["src","onClick"],re={class:"form-actions"},se=["src"],ne=O({__name:"AddReserve",setup(ue){const x="http://123.57.237.81:8080/caresystem-server/api",v="http://123.57.237.81:8080/caresystem/",B=x+"/upload/add",u=p(""),w=p(!1),U=p(""),I=j(()=>u.value?u.value.split(",").filter(o=>o.trim()).map(o=>o.startsWith("http")?o:v+o):[]),M=o=>{U.value=o,w.value=!0},C=z();console.log("路由信息：",C);const Y=R({name:[{required:!0,message:"请输入预定人姓名",trigger:"blur"}],mobile:[{required:!0,message:"请输入预定人电话",trigger:"blur"},{pattern:/^1[3-9]\d{9}$/,message:"请输入正确的11位手机号",trigger:"blur"}],relation:[{required:!0,message:"请选择与老人关系",trigger:"change"}],bed:[{required:!0,message:"请选择床位",trigger:"change"}],startDate:[{required:!0,message:"请选择开始日期",trigger:"change"}],day:[{required:!0,message:"请输入预定时长",trigger:"blur"}],amount:[{required:!0,message:"请输入定金金额",trigger:"blur"}]}),e=R({begId:0,name:"",mobile:"",relation:"",bed:"",startDate:"",day:null,amount:null,files:[],elderlyId:""});G(()=>{const o=C.query.id;console.log(111,o),e.elderlyId=o});let E=o=>{const l=o[o.length-1];e.begId=typeof l=="number"?l:parseInt(l),e.bed=l.toString()};const c=p(),b=p(),y=p(!1),F=async()=>{if(!c.value){i.error("表单初始化失败，请刷新页面重试");return}try{if(await c.value.validate(),y.value=!0,console.log("开始表单验证，当前表单数据：",JSON.parse(JSON.stringify(e))),!u.value||u.value.trim()===""){i.warning("请先上传预定协议图片！"),y.value=!1;return}e.files=I.value.map(s=>{const n=s.split("/").pop()||"预定协议图片";return{file:s.startsWith(v)?s.replace(v,""):s,fileName:n}});const o={...e,elderlyId:typeof e.elderlyId=="number"?e.elderlyId:parseInt(e.elderlyId||"0"),day:typeof e.day=="number"?e.day:parseInt(e.day||"0"),amount:typeof e.amount=="number"?e.amount:parseFloat(e.amount||"0")};console.log("最终提交到接口的数据：",o);const l=new Promise((s,n)=>{setTimeout(()=>n(new Error("接口请求超时")),1e4)}),m=await Promise.race([J(o),l]);console.log("接口返回结果：",m),i.success("预定信息提交成功！"),X.push("/Reserve")}catch(o){console.error("提交异常详情：",o),o.message.includes("Validation failed")?i.warning("表单填写不完整，请检查必填项"):o.message==="接口请求超时"?i.error("提交失败：请求服务器超时，请检查网络或稍后重试"):i.error(`提交失败：${o.message||"未知错误"}`)}finally{y.value=!1}},N=()=>{c.value&&c.value.resetFields(),e.begId=0,e.name="",e.mobile="",e.relation="",e.bed="",e.startDate="",e.day=null,e.amount=null,e.files=[],u.value="",b.value&&typeof b.value.clearFiles=="function"&&b.value.clearFiles(),i.info("已取消当前操作，表单已重置")};return(o,l)=>{const m=d("el-input"),s=d("el-form-item"),n=d("el-col"),g=d("el-row"),P=d("el-date-picker"),k=d("el-button"),S=d("el-form"),T=d("el-dialog");return _(),V("div",ee,[t(S,{ref_key:"formRef",ref:c,model:e,rules:Y,"label-width":"150px",class:"reservation-form"},{default:a(()=>[f("div",le,[l[9]||(l[9]=f("h3",{class:"section-title"},"预定信息",-1)),t(g,{gutter:20},{default:a(()=>[t(n,{span:12},{default:a(()=>[t(s,{label:"预定人姓名:",prop:"name"},{default:a(()=>[t(m,{modelValue:e.name,"onUpdate:modelValue":l[0]||(l[0]=r=>e.name=r),placeholder:"请输入姓名",clearable:""},null,8,["modelValue"])]),_:1})]),_:1}),t(n,{span:12},{default:a(()=>[t(s,{label:"预定人电话:",prop:"mobile"},{default:a(()=>[t(m,{modelValue:e.mobile,"onUpdate:modelValue":l[1]||(l[1]=r=>e.mobile=r),placeholder:"请输入预定人电话",clearable:""},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),t(g,{gutter:20},{default:a(()=>[t(n,{span:12},{default:a(()=>[t(s,{label:"与老人关系:",prop:"relation"},{default:a(()=>[t($,{modelValue:e.relation,"onUpdate:modelValue":l[2]||(l[2]=r=>e.relation=r)},null,8,["modelValue"])]),_:1})]),_:1}),t(n,{span:12},{default:a(()=>[t(s,{label:"床位",prop:"bed"},{default:a(()=>[t(A,{onBedChange:h(E),modelValue:e.bed,"onUpdate:modelValue":l[3]||(l[3]=r=>e.bed=r)},null,8,["onBedChange","modelValue"])]),_:1})]),_:1})]),_:1}),t(g,{gutter:20},{default:a(()=>[t(n,{span:12},{default:a(()=>[t(s,{label:"开始日期:",prop:"startDate"},{default:a(()=>[t(P,{modelValue:e.startDate,"onUpdate:modelValue":l[4]||(l[4]=r=>e.startDate=r),type:"date",placeholder:"请选择",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1}),t(n,{span:12},{default:a(()=>[t(s,{label:"预定时长（天）:",prop:"day"},{default:a(()=>[t(m,{modelValue:e.day,"onUpdate:modelValue":l[5]||(l[5]=r=>e.day=r),placeholder:"请输入预定时长",type:"number",clearable:"",min:"1"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),t(g,{gutter:20},{default:a(()=>[t(n,{span:12},{default:a(()=>[t(s,{label:"定金应收:",prop:"amount"},{default:a(()=>[t(m,{modelValue:e.amount,"onUpdate:modelValue":l[6]||(l[6]=r=>e.amount=r),placeholder:"请输入定金应收",type:"number",clearable:"",min:"0",step:"0.01"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),f("div",te,[l[11]||(l[11]=f("h3",{class:"section-title"},"预定协议",-1)),t(s,{class:"FormWraps"},{default:a(()=>[!u.value||u.value.trim()===""?(_(),H(W,{key:0,ref_key:"uploadRef",ref:b,modelValue:u.value,"onUpdate:modelValue":l[7]||(l[7]=r=>u.value=r),baseUrl:h(v),uploadUrl:B,isText:!0},{"upload-text":a(()=>[t(k,{type:"primary"},{default:a(()=>[...l[10]||(l[10]=[D("上传图片",-1)])]),_:1})]),_:1},8,["modelValue","baseUrl"])):q("",!0),I.value.length>0?(_(),V("div",ae,[(_(!0),V(K,null,Q(I.value,(r,L)=>(_(),V("img",{key:L,src:r,alt:"预定协议图片",class:"preview-img",onClick:de=>M(r)},null,8,oe))),128))])):q("",!0)]),_:1})]),f("div",re,[t(k,{type:"primary",loading:y.value,onClick:F},{default:a(()=>[...l[12]||(l[12]=[D(" 保存并提交 ",-1)])]),_:1},8,["loading"]),t(k,{onClick:N},{default:a(()=>[...l[13]||(l[13]=[D("取消",-1)])]),_:1})])]),_:1},8,["model","rules"]),t(T,{modelValue:w.value,"onUpdate:modelValue":l[8]||(l[8]=r=>w.value=r),title:"协议图片预览",width:"80%","append-to-body":""},{default:a(()=>[f("img",{src:U.value,alt:"大图预览",class:"big-preview-img",style:{width:"100%"}},null,8,se)]),_:1},8,["modelValue"])])}}}),be=Z(ne,[["__scopeId","data-v-3173c4a1"]]);export{be as default};
