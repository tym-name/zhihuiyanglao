import{d as B,r as g,k as x,l as q,o as j,h as n,c as _,e as r,w as d,a as u,R as $,g as H,v as J,F as h,f as v,S as K,b as T,_ as L}from"./index-D6YPj1KB.js";import{_ as P}from"./Relation.vue_vue_type_script_setup_true_lang-X-1nezkQ.js";import{c as Q,g as W}from"./goout-CH0kKKLF.js";const X={style:{"font-size":"16px","font-weight":"600","margin-bottom":"20px"}},Z={name:"AddGoOut"},ee=B({...Z,props:{elderlyInfo:{},editInfo:{}},emits:["submitSuccess","cancel"],setup(O,{expose:E,emit:k}){const f=$(),N=K(),s=O,y=k,I=g(!1),m=g(!!s.editInfo),F=g("default"),c=g(),p=g(null),b=()=>{const l=s.elderlyInfo?.id||Number(f.query.elderlyId)||Number(localStorage.getItem("elderlyId"))||0,t=s.elderlyInfo?.name||f.query.elderlyName||localStorage.getItem("elderlyName")||"";return{elderlyId:l,elderlyName:t}},V=()=>{const{elderlyId:l,elderlyName:t}=b();return s.editInfo?{...s.editInfo,elderlyId:s.editInfo.elderlyId||l,elderlyName:s.editInfo.elderlyName||t}:{name:"",id:0,companyId:Number(localStorage.getItem("companyId"))||0,elderlyId:l,elderlyName:t,startTime:"",endTime:"",mobile:"",address:"",content:"",state:0,relation:"",addTime:new Date().toISOString(),addAccountId:Number(localStorage.getItem("userId"))||0}},e=x(V()),U=x({elderlyName:[{required:!0,message:"请先选择外出老人",trigger:"blur"}],startTime:[{required:!0,message:"请选择外出时间",trigger:"change"},{validator:(l,t,o)=>{!e.startTime||!e.endTime?o(new Error("请完整选择开始和结束时间")):new Date(e.startTime)>new Date(e.endTime)?o(new Error("开始时间不能晚于结束时间")):o()},trigger:"change"}],relation:[{required:!0,message:"请选择陪同人关系",trigger:"blur"}],name:[{required:!0,message:"请输入陪同人姓名",trigger:"blur"}],mobile:[{required:!0,message:"请输入陪同人电话",trigger:"blur"},{pattern:/^1[3456789]\d{9}$/,message:"请输入正确的手机号",trigger:"blur"}],address:[{required:!0,message:"请输入陪同人地址",trigger:"blur"}],content:[{required:!0,message:"请输入外出原因",trigger:"blur"}]}),Y=l=>{l?.id&&l?.name!==void 0?(e.elderlyId=l.id,e.elderlyName=l.name,localStorage.setItem("elderlyId",l.id.toString()),localStorage.setItem("elderlyName",l.name||"")):n.error("老人信息不完整")},C=l=>{if(l){const[t,o]=l;if(new Date(t)>new Date(o)){n.error("开始时间不能晚于结束时间，请重新选择"),p.value=null,e.startTime="",e.endTime="";return}e.startTime=t,e.endTime=o}else e.startTime="",e.endTime=""},R=()=>{y("cancel"),N.push("/GoOut")},z=async()=>{if(!c.value)return;try{await c.value.validate()}catch{n.error("请完善表单必填项");return}if(!e.elderlyId||!e.elderlyName){n.error("请先选择外出老人");return}if(!e.startTime||!e.endTime){n.error("请完整选择外出时间");return}const l={id:e.id,elderlyId:e.elderlyId,elderlyName:e.elderlyName,startTime:e.startTime,endTime:e.endTime,mobile:e.mobile||"",address:e.address||"",content:e.content||"",relation:e.relation||"",name:e.name||"",companyId:e.companyId||Number(localStorage.getItem("companyId"))||0,state:e.state||0,addTime:e.addTime||new Date().toISOString(),addAccountId:e.addAccountId||Number(localStorage.getItem("userId"))||0};I.value=!0;try{if(m.value)(await Q(l)).code===1e4&&(n.success("修改成功"),y("submitSuccess"));else{const t=await W(l);console.log("添加外出登记信息",t),t.code===1e4&&(n.success("添加成功"),y("submitSuccess"),w())}N.push("/GoOut")}catch(t){n.error("网络异常，请稍后重试"),console.error("提交失败：",t)}finally{I.value=!1}},w=()=>{c.value&&c.value.resetFields(),p.value=null;const{elderlyId:l,elderlyName:t}=b();Object.assign(e,{name:"",elderlyId:l,elderlyName:t,startTime:"",endTime:"",mobile:"",address:"",content:"",relation:"",id:m.value?e.id:0})},S=()=>{m.value&&e.startTime&&e.endTime&&(p.value=[e.startTime,e.endTime])};return q([()=>f.query.elderlyId,()=>f.query.elderlyName],()=>{const{elderlyId:l,elderlyName:t}=b();e.elderlyId=l,e.elderlyName=t},{immediate:!0}),q(()=>s.editInfo,l=>{l&&(m.value=!0,Object.assign(e,V()),S())},{immediate:!0}),j(()=>{S(),e.elderlyId||n.warning("请先返回选择外出老人")}),E({resetForm:w,handleSingleElderly:Y}),(l,t)=>{const o=u("el-input"),i=u("el-form-item"),M=u("el-date-picker"),G=u("el-form"),D=u("el-button"),A=u("el-card");return T(),_("div",null,[r(A,null,{default:d(()=>[H("div",X,J(m.value?"编辑外出登记":"新增外出登记"),1),r(G,{ref_key:"ruleFormRef",ref:c,style:{"max-width":"600px"},model:e,rules:U,"label-width":"auto"},{default:d(()=>[r(i,{label:"选择外出老人",prop:"elderlyName"},{default:d(()=>[r(o,{modelValue:e.elderlyName,"onUpdate:modelValue":t[0]||(t[0]=a=>e.elderlyName=a),disabled:""},null,8,["modelValue"])]),_:1}),r(i,{label:"外出时间",prop:"startTime"},{default:d(()=>[r(M,{modelValue:p.value,"onUpdate:modelValue":t[1]||(t[1]=a=>p.value=a),type:"daterange","range-separator":"-","start-placeholder":"选择开始时间","end-placeholder":"选择结束时间",size:F.value,style:{width:"100%"},onChange:C,format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",disabled:m.value},null,8,["modelValue","size","disabled"])]),_:1}),r(i,{label:"陪同人员类型",prop:"relation",placement:"bottom"},{default:d(()=>[r(P,{modelValue:e.relation,"onUpdate:modelValue":t[2]||(t[2]=a=>e.relation=a)},null,8,["modelValue"])]),_:1}),r(i,{label:"陪同人员姓名",prop:"name"},{default:d(()=>[r(o,{modelValue:e.name,"onUpdate:modelValue":t[3]||(t[3]=a=>e.name=a),placeholder:"请输入陪同人员姓名"},null,8,["modelValue"])]),_:1}),r(i,{label:"陪同人员电话",prop:"mobile"},{default:d(()=>[r(o,{modelValue:e.mobile,"onUpdate:modelValue":t[4]||(t[4]=a=>e.mobile=a),placeholder:"请输入11位手机号码"},null,8,["modelValue"])]),_:1}),r(i,{label:"陪同人员地址",prop:"address"},{default:d(()=>[r(o,{modelValue:e.address,"onUpdate:modelValue":t[5]||(t[5]=a=>e.address=a),placeholder:"请输入陪同人员详细地址"},null,8,["modelValue"])]),_:1}),r(i,{label:"外出原因",prop:"content"},{default:d(()=>[r(o,{modelValue:e.content,"onUpdate:modelValue":t[6]||(t[6]=a=>e.content=a),style:{width:"500px"},rows:2,type:"textarea",placeholder:"请输入外出原因"},null,8,["modelValue"])]),_:1})]),_:1},8,["model","rules"]),r(D,{size:"small",type:"primary",onClick:z,loading:I.value},{default:d(()=>[m.value?(T(),_(h,{key:0},[v("保存修改")],64)):(T(),_(h,{key:1},[v("保存")],64))]),_:1},8,["loading"]),r(D,{size:"small",onClick:R},{default:d(()=>[...t[7]||(t[7]=[v("取消",-1)])]),_:1})]),_:1})])}}}),ae=L(ee,[["__scopeId","data-v-824a4f31"]]);export{ae as default};
