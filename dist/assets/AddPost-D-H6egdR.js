import{m as D,r as M,a as V}from"./position-BwEY5D3f.js";import{d as E,z as L,r as h,k as g,o as P,n as q,w as u,I as A,E as m,b as i,e as l,g as k,B as v,a as U,_ as $}from"./index-DSXWNbz6.js";const z=E({__name:"AddPost",setup(G){const _=L(),p=_.params.id?Number(_.params.id):0,f=h(),c=h(),C=g({name:{required:!0,message:"请输入岗位名称",trigger:"blur"},menuIds:{required:!0,validator:(o,e)=>{!o||o.length===0?e(new Error("请至少选择一个权限")):e()},trigger:"change"}}),N={label:"name",children:"children"},y=h([]),b=h([]),t=g({id:0,name:"",companyId:0,addAccountId:0,addAccountName:null,addTime:"",accountCounts:0,menuIds:[]}),w=async()=>{try{const e=await D({id:0,name:"",icon:null,url:null,pathName:null,pid:0,sort:0,type:0,isButton:0});console.log("权限配置",e),e.data&&e.data.list&&(b.value=e.data.list,y.value=x(e.data.list),await A(),p>0&&await F())}catch(o){console.error("获取权限列表失败:",o),m.error("获取权限列表失败")}},x=o=>{const e=new Map,a=[];o.forEach(n=>{e.set(n.id,{id:n.id,name:n.name,icon:n.icon,url:n.url,pathName:n.pathName,pid:n.pid,sort:n.sort,type:n.type,isButton:n.isButton,children:[]})}),o.forEach(n=>{const r=e.get(n.id);if(r)if(n.pid===0)a.push(r);else{const d=e.get(n.pid);d?d.children.push(r):a.push(r)}});const s=n=>(n.sort((r,d)=>(r.sort||0)-(d.sort||0)),n.forEach(r=>{r.children&&r.children.length>0&&s(r.children)}),n);return s(a)},T=o=>{const{checkedKeys:e,halfCheckedKeys:a}=o,s=[...e,...a];t.menuIds=s,f.value?.validateField("menuIds")},F=async()=>{try{const e=await M({id:p,name:"",companyId:0,addAccountId:0,addAccountName:null,addTime:"",accountCounts:0,menuIds:null});if(console.log("岗位列表响应:",e),e.data&&e.data.list&&e.data.list.length>0){const a=e.data.list.find(s=>s.id===p);if(a){t.id=a.id,t.name=a.name,t.companyId=a.companyId,t.addAccountId=a.addAccountId,t.addAccountName=a.addAccountName,t.addTime=a.addTime,t.accountCounts=a.accountCounts;let s=[];if(a.menuIds){if(Array.isArray(a.menuIds))s=a.menuIds;else if(typeof a.menuIds=="string")try{s=JSON.parse(a.menuIds)}catch{s=[]}}t.menuIds=s,console.log("菜单ID已设置:",t.menuIds),s.length>0&&y.value.length>0&&(await A(),c.value&&(console.log("设置树形控件选中状态:",s),c.value.setCheckedKeys(s),c.value.getCheckedKeys()))}}}catch{m.error("获取岗位详情失败")}},B=async o=>{o&&await o.validate(async e=>{if(e)try{const a={...t,addAccountName:t.addAccountName,menuIds:Array.isArray(t.menuIds)?t.menuIds:[]};console.log("提交的数据:",a),await V(a),p>0?m.success("更新成功"):m.success("添加成功"),v.back()}catch{m.error("提交失败")}})},K=o=>{o&&(o.resetFields(),c.value&&c.value.setCheckedKeys([]),t.id=0,t.name="",t.companyId=0,t.addAccountId=0,t.addAccountName=null,t.addTime="",t.accountCounts=0,t.menuIds=[],v.back())};return P(()=>{w()}),(o,e)=>{const a=i("el-input"),s=i("el-form-item"),n=i("el-tree"),r=i("el-form"),d=i("el-button"),R=i("el-card");return U(),q(R,null,{default:u(()=>[l(r,{ref_key:"ruleFormRef",ref:f,model:t,style:{"max-width":"600px"},rules:C,"label-width":"auto"},{default:u(()=>[l(s,{label:"岗位名称",prop:"name"},{default:u(()=>[l(a,{modelValue:t.name,"onUpdate:modelValue":e[0]||(e[0]=I=>t.name=I),placeholder:"请输入岗位名称"},null,8,["modelValue"])]),_:1}),l(s,{label:"权限配置",prop:"menuIds"},{default:u(()=>[l(n,{ref_key:"treeRef",ref:c,data:y.value,"node-key":"id",props:N,"show-checkbox":"","highlight-current":"",onCheck:T},null,8,["data"])]),_:1})]),_:1},8,["model","rules"]),l(d,{onClick:e[1]||(e[1]=I=>K(f.value))},{default:u(()=>[...e[3]||(e[3]=[k("取消",-1)])]),_:1}),l(d,{type:"primary",onClick:e[2]||(e[2]=I=>B(f.value))},{default:u(()=>[...e[4]||(e[4]=[k(" 确定 ",-1)])]),_:1})]),_:1})}}}),S=$(z,[["__scopeId","data-v-da65ea53"]]);export{S as default};
