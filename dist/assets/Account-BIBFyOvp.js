import{D as _,d as S,j as z,k as M,r as p,n as F,w as n,E as u,I as E,b,e as a,p as H,u as j,c as P,v as J,F as Q,f as V,g as y,q as W,s as X,a as I,_ as G,h as N}from"./index-DSXWNbz6.js";import{T as Y}from"./table-BDVlGf5e.js";import{u as Z}from"./Uploads-hqb4toZy.js";import{R as ee}from"./ResetPasswordDialog-7pXUQv3z.js";import"./company-2RAv3DgF.js";const te=c=>_.get("/account/list",c),oe=(c=>_.delete(`/account/delete/${c}`)),le=(c=>_.post("/account/deleteAll",c)),ae=()=>_.get("/role/list"),se=c=>_.post("/account/add",c),ne=c=>_.get(`/account/get/${c}`),re=c=>_.put("/account/update",c),ue={class:"dialog-footer"},ie=S({__name:"AccountDialog",emits:["refreshAccountList"],setup(c,{expose:T,emit:C}){const m=C,$=z(()=>t.id&&t.id>0?"修改账号":"添加账号"),h="http://123.57.237.81:8080/caresystem-server/api",R="http://123.57.237.81:8080/caresystem/",k=h+"/upload/add",w=p(),v=p(!1),t=M({id:0,username:"",pwd:"",name:"",enable:1,photo:"",mobile:"",roleIds:[]}),g=M({photo:{required:!0,message:"头像不能为空",trigger:"blur"},username:{required:!0,message:"姓名不能为空",trigger:"blur"},mobile:[{required:!0,message:"手机号不能为空",trigger:"blur"},{pattern:/^1[3-9]\d{9}$/,message:"请输入正确的手机号格式",trigger:"blur"}],name:{required:!0,message:"账号不能为空",trigger:"blur"},pwd:{required:!0,message:"请输入密码",trigger:"blur"},roleIds:{required:!0,message:"请选择角色",trigger:"change",validator:(o,e)=>Array.isArray(e)&&e.length>0}}),x=p([]),D=async()=>{try{const o=await ae();console.log("所属角色",o),o.code===1e4&&o.data?.list?x.value=o.data.list:u.error("获取角色列表失败")}catch(o){console.error("获取角色列表失败：",o),u.error("加载角色列表失败，请刷新重试")}};D();const A=()=>{Object.assign(t,{id:0,username:"",pwd:"",name:"",enable:1,photo:"",mobile:"",roleIds:[]})},U=async o=>{try{const e=await ne(o);if(console.log("账号详情",e),e.code===1e4&&e.data){const l=e.data;t.id=l.id||0,t.username=l.name||"",t.mobile=l.mobile||"",t.name=l.username||"",t.photo=l.photo||"",t.roleIds=l.roleIds?Array.isArray(l.roleIds)?l.roleIds:[l.roleIds]:[],E(()=>{w.value?.clearValidate("roleIds")})}else u.error("获取账号详情失败")}catch(e){console.error("获取账号详情失败：",e),u.error("加载账号详情失败，请刷新重试")}},B=async o=>{if(o)try{await o.validate(async e=>{if(e){const l={...t};let d;if(t.id&&t.id>0)d=await re(l);else{let f;try{if(f=await W(),!f.data){u.error("获取加密公钥失败，无法提交");return}l.pwd=X.sm2.doEncrypt(t.pwd,f.data,1)}catch(L){console.error("密码加密失败：",L),u.error("密码加密失败，请重试");return}d=await se(l)}if(console.log(t.id>0?"编辑账号结果":"添加账号结果",d),d.code===1e4){const f=t.id>0?"编辑成功":"提交成功";u.success(f),v.value=!1,m("refreshAccountList")}else{const f=d.msg||(t.id>0?"编辑失败":"提交失败");u.error(f)}}else u.error("表单填写有误，请检查后提交")})}catch(e){console.error("提交流程异常：",e),u.error("提交失败，请稍后重试")}},r=o=>{o&&E(()=>{o.resetFields()}),v.value=!1,A()};return T({openDialog:o=>{A(),v.value=!0,o&&o.id&&E(async()=>{x.value.length===0&&await D(),await U(o.id)})}}),(o,e)=>{const l=b("el-form-item"),d=b("el-input"),f=b("el-option"),L=b("el-select"),K=b("el-form"),q=b("el-button"),O=b("el-dialog");return I(),F(O,{modelValue:v.value,"onUpdate:modelValue":e[8]||(e[8]=s=>v.value=s),title:$.value,style:{width:"450px"}},{footer:n(()=>[V("div",ue,[a(q,{onClick:e[6]||(e[6]=s=>r(w.value))},{default:n(()=>[...e[9]||(e[9]=[y("关闭",-1)])]),_:1}),a(q,{type:"primary",onClick:e[7]||(e[7]=s=>B(w.value))},{default:n(()=>[...e[10]||(e[10]=[y(" 提交 ",-1)])]),_:1})])]),default:n(()=>[a(K,{model:t,"label-width":"auto",rules:g,ref_key:"ruleFormRef",ref:w},{default:n(()=>[a(l,{label:"头像",prop:"photo"},{default:n(()=>[a(Z,{modelValue:t.photo,"onUpdate:modelValue":e[0]||(e[0]=s=>t.photo=s),baseUrl:j(R),uploadUrl:k},null,8,["modelValue","baseUrl"])]),_:1}),a(l,{label:"姓名",prop:"username"},{default:n(()=>[a(d,{modelValue:t.username,"onUpdate:modelValue":e[1]||(e[1]=s=>t.username=s),placeholder:"请输入姓名",style:{width:"222.54px"}},null,8,["modelValue"])]),_:1}),a(l,{label:"手机号",prop:"mobile"},{default:n(()=>[a(d,{modelValue:t.mobile,"onUpdate:modelValue":e[2]||(e[2]=s=>t.mobile=s),placeholder:"请输入手机号",style:{width:"222.54px"}},null,8,["modelValue"])]),_:1}),a(l,{label:"账号",prop:"name"},{default:n(()=>[a(d,{modelValue:t.name,"onUpdate:modelValue":e[3]||(e[3]=s=>t.name=s),placeholder:"请输入账号",style:{width:"222.54px"}},null,8,["modelValue"])]),_:1}),t.id?H("",!0):(I(),F(l,{key:0,label:"密码",prop:"pwd"},{default:n(()=>[a(d,{modelValue:t.pwd,"onUpdate:modelValue":e[4]||(e[4]=s=>t.pwd=s),type:"password",placeholder:"请输入密码",style:{width:"222.54px"}},null,8,["modelValue"])]),_:1})),a(l,{label:"所属角色",prop:"roleIds"},{default:n(()=>[a(L,{modelValue:t.roleIds,"onUpdate:modelValue":e[5]||(e[5]=s=>t.roleIds=s),multiple:"",placeholder:"请选择",style:{width:"222.54px"}},{default:n(()=>[(I(!0),P(Q,null,J(x.value,s=>(I(),F(f,{key:s.id,label:s.name,value:s.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["modelValue","title"])}}}),ce=G(ie,[["__scopeId","data-v-dea29f4e"]]),de=S({__name:"Account",setup(c){const T=[{type:"selection",width:"50"},{label:"序号",prop:"id",width:"100px"},{label:"姓名",prop:"name"},{label:"手机号",prop:"mobile"},{label:"账号",prop:"username"},{label:"操作",slot:"operate",width:260,fixed:"right"}],C=p([]),m=p([]),$=r=>{C.value=r,m.value=r.map(i=>i.id)},h=p(!1),R=p(0),k=p(""),w=r=>{R.value=r.id,k.value=r.name,h.value=!0,console.log("传递给弹窗的机构名称：",k.value)},v=()=>{h.value=!1,g.value?.refresh()},t=r=>{u.error(`密码重置失败：${r.msg||"未知错误"}`),console.error("重置密码失败:",r)},g=p(null),x=r=>{N.confirm("是否删除该条记录？",{confirmButtonText:"确定",cancelButtonText:"取消"}).then(async()=>{u({type:"success",message:"删除成功"}),await oe(r),g.value?.refresh()}).catch(()=>{u({type:"info",message:"取消删除"})})},D=()=>{if(m.value.length===0){u.warning("请至少选择一条记录");return}N.confirm(`确定要删除选中的 ${m.value.length} 条记录吗？`,"批量删除确认",{confirmButtonText:"确定删除",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{await le(m.value),u({type:"success",message:`成功删除 ${m.value.length} 条记录`}),C.value=[],m.value=[],g.value?.refresh()}catch{u.error("删除失败，请重试")}}).catch(()=>{u({type:"info",message:"取消批量删除"})})},A=p(),U=r=>{A.value?.openDialog(r)},B=async()=>{try{g.value&&g.value.refresh()}catch(r){console.error("刷新账号列表失败：",r),u.error("刷新列表失败，请手动刷新")}};return(r,i)=>{const o=b("el-button");return I(),P("div",null,[a(Y,{ref_key:"tableRef",ref:g,columns:T,"fetch-data":j(te),onSelectionChange:$},{buttons:n(()=>[a(o,{type:"success",onClick:U},{default:n(()=>[...i[1]||(i[1]=[V("i",{class:"iconfont icon-jia"},null,-1),y("添加账号",-1)])]),_:1}),a(o,{type:"danger",disabled:m.value.length===0,onClick:D},{default:n(()=>[...i[2]||(i[2]=[V("i",{class:"iconfont icon-shanchu"},null,-1),y("批量删除",-1)])]),_:1},8,["disabled"])]),operate:n(({row:e})=>[a(o,{link:"",type:"primary",onClick:l=>w(e)},{default:n(()=>[...i[3]||(i[3]=[V("i",{class:"iconfont icon-shuaxin"},null,-1),y("重置密码",-1)])]),_:1},8,["onClick"]),a(o,{link:"",type:"primary",onClick:l=>U(e)},{default:n(()=>[...i[4]||(i[4]=[V("i",{class:"iconfont icon-bianji"},null,-1),y("修改",-1)])]),_:1},8,["onClick"]),a(o,{link:"",type:"danger",onClick:l=>x(e.id)},{default:n(()=>[...i[5]||(i[5]=[V("i",{class:"iconfont icon-shanchu"},null,-1),y("删除",-1)])]),_:1},8,["onClick"])]),_:1},8,["fetch-data"]),a(ce,{ref_key:"accountDialogRef",ref:A,onRefreshAccountList:B},null,512),a(ee,{visible:h.value,"onUpdate:visible":i[0]||(i[0]=e=>h.value=e),"account-id":R.value,name:k.value,onResetSuccess:v,onResetFail:t},null,8,["visible","account-id","name"])])}}}),ve=G(de,[["__scopeId","data-v-4a32899b"]]);export{ve as default};
